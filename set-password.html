<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تعيين كلمة السر – هابيت تراكر</title>
<style>
  body{font-family:"Tajawal","Noto Kufi Arabic",system-ui;max-width:560px;margin:40px auto;padding:16px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  input{padding:12px;border:1px solid #bbb;border-radius:10px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #0ea5e9;background:#0ea5e9;color:#fff;cursor:pointer}
  .note{padding:10px;border-radius:10px;background:#f1f5f9;border:1px solid #e2e8f0;margin-top:10px}
</style>
</head>
<body>
  <h2>تعيين كلمة السر</h2>
  <div class="card">
    <p>تم التحقق من بريدك. عيّن كلمة سر لاستخدامها لاحقًا عند تسجيل الدخول.</p>

    <div class="field">
      <label>الإيميل (إن لم يظهر تلقائيًا)</label>
      <input id="email" placeholder="name@example.com">
    </div>

    <div class="field">
      <label>كلمة السر الجديدة</label>
      <input id="pass" type="password" placeholder="••••••••">
    </div>

    <button id="saveBtn">حفظ الكلمة والمتابعة</button>
    <div id="msg" class="note" style="display:none"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, isSignInWithEmailLink, signInWithEmailLink, updatePassword } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// قيم مشروعك
const firebaseConfig = {
  apiKey: "AIzaSyBhgjrD1MQmmDfrg8JD2Wj0QrnSre3zJ8",
  authDomain: "habit-tracker-7ccd1.firebaseapp.com",
  projectId: "habit-tracker-7ccd1",
  storageBucket: "habit-tracker-7ccd1.appspot.com",
  messagingSenderId: "890195716939",
  appId: "1:890195716939:web:2667409802ce22366b56ce",
  measurementId: "G-ZJLNEQXWD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const $ = s => document.querySelector(s);
const msg = $('#msg');
const show = t => { msg.textContent=t; msg.style.display='block'; };

(async function init(){
  // لو الإيميل محفوظ من صفحة التسجيل نعبّيه تلقائيًا
  const saved = window.localStorage.getItem('emailForSignIn');
  if(saved) $('#email').value = saved;

  // يجب فتح الصفحة عبر رابط التحقق
  if(!isSignInWithEmailLink(auth, window.location.href)){
    show('الرابط غير صالح. افتح الصفحة من رابط التأكيد المرسل إلى بريدك.');
    return;
  }

  // عند الضغط حفظ: نسجّل دخول بالرابط ثم نعيّن كلمة السر
  $('#saveBtn').onclick = async ()=>{
    try{
      const email = ($('#email').value || saved || '').trim();
      if(!email){ show('أدخل بريدك الإلكتروني.'); return; }

      const pass = $('#pass').value;
      if(!pass || pass.length < 6){ show('كلمة السر يجب أن تكون 6 أحرف على الأقل.'); return; }

      const cred = await signInWithEmailLink(auth, email, window.location.href);
      await updatePassword(cred.user, pass);

      // تنظيف وتوجيه
      window.localStorage.removeItem('emailForSignIn');
      show('تم تعيين كلمة السر بنجاح. سيتم تحويلك لتسجيل الدخول...');
      setTimeout(()=>{ window.location.href = 'login.html'; }, 1200);
    }catch(e){
      show(e.message);
    }
  };
})();
</script>
</body>
</html>
